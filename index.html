<!DOCTYPE html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æ–°æ½Ÿ4å¤©3å¤œï½œæ—¥ç³»æ¥µç°¡æ—…éŠå°å·¥å…·</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2j+FWyNXQGEblhGVMjBHAtK6EdhO8VcQ/M+Bw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Custom Tailwind Colors (æ—¥ç³»ç„¡å°é¢¨) */
        :root {
            --color-primary-bg: #F8F4E8; /* ç±³ç™½èƒŒæ™¯ */
            --color-primary-text: #333333; /* æ·±ç°æ–‡å­— */
            --color-accent-green: #7D9D9C; /* æŠ¹èŒ¶ç¶ é»ç¶´ */
            --color-accent-brown: #C7B198; /* æœ¨è³ªæ£•é»ç¶´ */
            --color-card-bg: #FFFFFF;
            --color-border: #E0E0E0;
            --color-highlight-orange: #E67E22; /* é‡è¦æé†’ */
            --color-highlight-blue: #3498DB; /* é€£çµ */
        }

        body {
            font-family: 'Noto Sans TC', 'M PLUS Rounded 1c', sans-serif;
            background-color: var(--color-primary-bg);
            color: var(--color-primary-text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: none; /* é˜²æ­¢æ‰‹æ©Ÿç€è¦½å™¨æ©¡çš®ç­‹æ•ˆæœ */
        }

        .font-jp {
            font-family: 'M PLUS Rounded 1c', sans-serif;
        }

        .tab-button.active {
            color: var(--color-accent-green);
            border-bottom: 3px solid var(--color-accent-green);
        }

        .card {
            background-color: var(--color-card-bg);
            border-radius: 1rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* shadow-md */
            border: 1px solid var(--color-border);
        }

        .input-style {
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
            background-color: var(--color-card-bg);
            color: var(--color-primary-text);
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        .input-style:focus {
            border-color: var(--color-accent-green);
        }
        .btn-primary {
            background-color: var(--color-accent-green);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem; /* rounded-lg */
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #6a8b8a; /* ç•¥æ·±ä¸€é»çš„ç¶  */
        }
        .btn-secondary {
            background-color: var(--color-accent-brown);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #b09a83; /* ç•¥æ·±ä¸€é»çš„æ£• */
        }
        .highlight-orange {
            background-color: #FEF3C7; /* bg-amber-100 */
            color: #D97706; /* text-amber-700 */
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.75rem;
        }
        .link-button {
            background-color: var(--color-highlight-blue);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            margin-top: 0.5rem;
            transition: background-color 0.2s;
        }
        .link-button:hover {
            background-color: #2b7bb9;
        }
        .badge-food { background-color: #FEE2E2; color: #DC2626; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-weight: 500; }
        .badge-buy { background-color: #DBEAFE; color: #2563EB; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-weight: 500; }
        .badge-tip { background-color: #ECFDF5; color: #059669; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-weight: 500; }

        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            .tab-button {
                padding: 0.75rem 0.5rem;
                font-size: 0.75rem;
            }
            .tab-button i {
                margin-bottom: 0.25rem;
            }
            .card {
                padding: 1rem;
            }
            .text-xl { font-size: 1.25rem; }
            .text-lg { font-size: 1.125rem; }
            .text-base { font-size: 1rem; }
            .text-sm { font-size: 0.875rem; }
            .text-xs { font-size: 0.75rem; }
        }

        /* Safe area for iPhone notch */
        body {
            padding-bottom: env(safe-area-inset-bottom);
        }
        .bottom-nav {
            padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
        }

        /* TimeLine Style */
        .timeline-item {
            position: relative;
            padding-left: 30px;
            margin-bottom: 20px;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 5px;
            width: 14px;
            height: 14px;
            background-color: var(--color-card-bg);
            border: 3px solid var(--color-accent-green);
            border-radius: 50%;
            z-index: 10;
        }

        .timeline-line {
            position: absolute;
            left: 6px;
            top: 20px;
            bottom: -20px;
            width: 2px;
            background-color: var(--color-border);
        }

        .timeline-end .timeline-line {
            display: none;
        }

        .timeline-important .timeline-dot {
            background-color: var(--color-highlight-orange);
            border-color: var(--color-highlight-orange);
            transform: scale(1.2);
        }
        .timeline-important .timeline-line {
            background-color: var(--color-highlight-orange);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="sticky top-0 bg-white/95 backdrop-blur-sm z-20 shadow-sm border-b border-border py-4 px-4">
        <h1 class="text-xl font-bold text-center text-accent-green">æ–°æ½Ÿæ—…ç¨‹</h1>
        <p class="text-center text-sm text-gray-500 mt-1">æ—¥ç³»æ¥µç°¡æ—…éŠå°å·¥å…·</p>
    </header>

    <main class="flex-1 overflow-y-auto p-4 md:p-6 max-w-2xl mx-auto w-full mb-20">
        
        <section id="plan" class="tab-content active">
            <h2 class="text-xl font-bold mb-6 text-accent-green">âœˆï¸ è¡Œç¨‹è¡¨ (PLAN)</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-plane mr-2"></i>èˆªç­è³‡è¨Š</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>å»ç¨‹ï¼š</strong><span class="font-jp text-base">IT228</span> å°åŒ— 13:45 â†’ æ–°æ½Ÿ 18:00</p>
                    <p><strong>å›ç¨‹ï¼š</strong><span class="font-jp text-base">IT229</span> æ–°æ½Ÿ 18:50 â†’ å°åŒ— 21:25</p>
                </div>
                <h3 class="text-lg font-bold mt-4 mb-3 text-accent-brown"><i class="fas fa-hotel mr-2"></i>ä½å®¿è³‡è¨Š</h3>
                <div class="space-y-2 text-sm">
                    <p><strong>é£¯åº—ï¼š</strong>æ–°æ½Ÿæ±æ€¥REIé£¯åº—</p>
                    <p><strong>åœ°å€ï¼š</strong>2 Chome-1-1 Benten, Chuo Ward, Niigata, 950-0086, Japan</p>
                </div>
            </div>

            <div id="itinerary-container">
                </div>
        </section>

        <section id="guide" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-6 text-accent-green">ğŸ—ºï¸ æ·±åº¦å°è¦½ (GUIDE)</h2>
            <div id="guide-content">
                </div>
        </section>

        <section id="wallet" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-6 text-accent-green">ğŸ’° è¨˜å¸³èˆ‡åŒ¯ç‡ (WALLET)</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-coins mr-2"></i>åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center mb-3">
                    <span class="mr-2 font-jp">1 TWD = </span>
                    <input type="number" id="exchangeRateInput" value="4.8" class="input-style w-24 text-center text-accent-green font-jp font-bold" step="0.01">
                    <span class="ml-2 font-jp"> JPY</span>
                </div>
                <input type="text" id="calcInput" class="input-style text-right text-lg font-jp mb-3" placeholder="è¼¸å…¥ç®—å¼ (ä¾‹å¦‚: 500+200*3)">
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <button class="btn-primary" onclick="appendCalc('7')">7</button>
                    <button class="btn-primary" onclick="appendCalc('8')">8</button>
                    <button class="btn-primary" onclick="appendCalc('9')">9</button>
                    <button class="btn-secondary" onclick="appendCalc('/')">/</button>
                    <button class="btn-primary" onclick="appendCalc('4')">4</button>
                    <button class="btn-primary" onclick="appendCalc('5')">5</button>
                    <button class="btn-primary" onclick="appendCalc('6')">6</button>
                    <button class="btn-secondary" onclick="appendCalc('*')">x</button>
                    <button class="btn-primary" onclick="appendCalc('1')">1</button>
                    <button class="btn-primary" onclick="appendCalc('2')">2</button>
                    <button class="btn-primary" onclick="appendCalc('3')">3</button>
                    <button class="btn-secondary" onclick="appendCalc('-')">-</button>
                    <button class="btn-primary" onclick="appendCalc('0')">0</button>
                    <button class="btn-secondary" onclick="appendCalc('.')">.</button>
                    <button class="btn-secondary" onclick="clearCalc()">C</button>
                    <button class="btn-secondary" onclick="appendCalc('+')">+</button>
                    <button class="col-span-4 btn-primary" onclick="calculateExchange()">= æ›ç®—</button>
                </div>
                <div class="text-right text-lg font-bold">
                    <p>æ—¥å¹£ç¸½é¡: <span id="totalJPY" class="text-accent-green font-jp">0</span> JPY</p>
                    <p>å°å¹£ç¸½é¡: <span id="totalTWD" class="text-accent-brown font-jp">0</span> TWD</p>
                </div>
            </div>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-clipboard-list mr-2"></i>è¨˜å¸³åŠŸèƒ½</h3>
                <div class="mb-4 space-y-3">
                    <input type="text" id="expenseItem" class="input-style" placeholder="å“é … (ä¾‹å¦‚: åˆé¤)">
                    <input type="number" id="expenseJPY" class="input-style font-jp" placeholder="æ—¥å¹£é‡‘é¡ (ä¾‹å¦‚: 1500)" step="1" min="0">
                    <input type="file" id="expensePhoto" accept="image/*" class="hidden" onchange="previewExpensePhoto(event)">
                    <button class="btn-secondary w-full flex items-center justify-center" onclick="document.getElementById('expensePhoto').click()">
                        <i class="fas fa-camera mr-2"></i> ä¸Šå‚³ç…§ç‰‡
                    </button>
                    <div id="photoPreviewContainer" class="mt-2 text-center hidden">
                        <img id="expensePhotoPreview" class="max-w-full h-24 object-contain mx-auto border border-border rounded-md">
                        <button onclick="removeExpensePhoto()" class="text-red-500 text-sm mt-1"><i class="fas fa-times-circle mr-1"></i>ç§»é™¤ç…§ç‰‡</button>
                    </div>
                    <button class="btn-primary w-full mt-3" onclick="addExpense()">
                        <i class="fas fa-plus-circle mr-2"></i>æ–°å¢è¨˜å¸³
                    </button>
                </div>

                <div class="border-t border-border mt-6 pt-4">
                    <h4 class="font-bold mb-2">è¨˜å¸³æ­·å²</h4>
                    <ul id="expenseList" class="space-y-3">
                        </ul>
                    <div class="text-right mt-4 pt-3 border-t border-border">
                        <p class="text-lg font-bold">ç¸½æ”¯å‡ºï¼š<span id="totalExpensesJPY" class="text-accent-green font-jp">0</span> JPY / <span id="totalExpensesTWD" class="text-accent-brown font-jp">0</span> TWD</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="lists" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-6 text-accent-green">ğŸ“ æ¸…å–® (LISTS)</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-list-check mr-2"></i>è¡Œå‰æº–å‚™ CheckList</h3>
                <ul id="checklist" class="space-y-2">
                    </ul>
                <div class="mt-4 flex space-x-2">
                    <input type="text" id="newChecklistItem" class="input-style flex-grow" placeholder="æ–°å¢æº–å‚™é …ç›®">
                    <button class="btn-primary px-3" onclick="addChecklistItem()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-note-sticky mr-2"></i>å€‹äººå‚™å¿˜éŒ„</h3>
                <textarea id="personalNotes" class="input-style min-h-[120px] mb-3" placeholder="åœ¨æ­¤è¼¸å…¥æ‚¨çš„ç­†è¨˜ï¼Œç¶²å€æœƒè‡ªå‹•è½‰æ›ç‚ºé€£çµ..."></textarea>
                <div id="notesOutput" class="space-y-2 text-sm">
                    </div>
                <button class="btn-primary w-full mt-3" onclick="saveNotes()">
                    <i class="fas fa-save mr-2"></i>å„²å­˜å‚™å¿˜éŒ„
                </button>
            </div>
        </section>

        <section id="info" class="tab-content hidden">
            <h2 class="text-xl font-bold mb-6 text-accent-green">â„¹ï¸ è³‡è¨Š (INFO)</h2>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-cloud-sun mr-2"></i>ç•¶åœ°å¤©æ°£é å ±</h3>
                <p class="text-sm mb-3">è«‹é»æ“Šé€£çµæŸ¥çœ‹æ–°æ½Ÿçš„å³æ™‚å¤©æ°£è³‡è¨Šã€‚</p>
                <a href="http://googleusercontent.com/jma.go.jp/jma/indexe.html" target="_blank" class="link-button">
                    <i class="fas fa-external-link-alt mr-2"></i> æ—¥æœ¬æ°£è±¡å»³
                </a>
            </div>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-phone-volume mr-2"></i>ç·Šæ€¥è¯çµ¡é›»è©±</h3>
                <ul class="space-y-2 text-sm">
                    <li><strong class="text-accent-green">è­¦å¯Ÿï¼š</strong><a href="tel:110" class="text-blue-600 hover:underline">110</a></li>
                    <li><strong class="text-accent-green">æ•‘è­·è»Š/æ¶ˆé˜²ï¼š</strong><a href="tel:119" class="text-blue-600 hover:underline">119</a></li>
                    <li><strong class="text-accent-green">å°åŒ—é§æ—¥ç¶“æ¿Ÿæ–‡åŒ–ä»£è¡¨è™•ï¼š</strong><a href="tel:+81-3-3280-7917" class="text-blue-600 hover:underline">+81-3-3280-7917</a></li>
                    <li><strong class="text-accent-green">é£¯åº—ï¼š</strong><a href="tel:+81252410109" class="text-blue-600 hover:underline">+81 25-241-0109</a> (æ–°æ½Ÿæ±æ€¥REIé£¯åº—)</li>
                </ul>
            </div>

            <div class="card p-4 mb-6">
                <h3 class="text-lg font-bold mb-3 text-accent-brown"><i class="fas fa-exclamation-triangle mr-2"></i>æ—…éŠæ³¨æ„äº‹é …</h3>
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong class="text-accent-green">è—¥å“æ”œå¸¶ï¼š</strong>è«‹æ³¨æ„æ—¥æœ¬å°è—¥å“æ”œå¸¶è¦å®šåš´æ ¼ï¼ŒæŸäº›æˆåˆ†å¯èƒ½éœ€è¦ç”³è«‹ã€‚</li>
                    <li><strong class="text-accent-green">ç¾é‡‘èˆ‡æ”¯ä»˜ï¼š</strong>é›–ç„¶é›»å­æ”¯ä»˜æ™®åŠï¼Œä½†ä»æœ‰è¨±å¤šå°åº—åƒ…æ”¶ç¾é‡‘ï¼Œå»ºè­°å‚™è¶³æ—¥å¹£ã€‚</li>
                    <li><strong class="text-accent-green">åƒåœ¾åˆ†é¡ï¼š</strong>æ—¥æœ¬åƒåœ¾åˆ†é¡éå¸¸ç´°ç·»ï¼Œè«‹å‹™å¿…éµå®ˆç•¶åœ°è¦å®šã€‚</li>
                    <li><strong class="text-accent-green">å…¬å…±å ´æ‰€ç¦®å„€ï¼š</strong>åœ¨å¤§çœ¾é‹è¼¸å·¥å…·ä¸Šè«‹ä¿æŒå®‰éœï¼Œé¿å…å¤§è²å–§å˜©ã€‚</li>
                    <li><strong class="text-accent-green">å‡ºå…¥å¢ƒé•ç¦å“ï¼š</strong>è‚‰é¡è£½å“ã€å‹•æ¤ç‰©ç”¢å“ç­‰åš´ç¦æ”œå¸¶å…¥å¢ƒï¼Œè«‹å‹™å¿…æª¢æŸ¥ã€‚</li>
                </ul>
            </div>
        </section>
    </main>

    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white shadow-lg border-t border-border py-3 px-2 flex justify-around z-50">
        <button class="tab-button flex flex-col items-center text-gray-500 flex-1 active" onclick="showTab('plan')">
            <i class="fas fa-map-marked-alt text-lg mb-1"></i>
            <span class="text-xs">è¡Œç¨‹</span>
        </button>
        <button class="tab-button flex flex-col items-center text-gray-500 flex-1" onclick="showTab('guide')">
            <i class="fas fa-book-open text-lg mb-1"></i>
            <span class="text-xs">å°è¦½</span>
        </button>
        <button class="tab-button flex flex-col items-center text-gray-500 flex-1" onclick="showTab('wallet')">
            <i class="fas fa-wallet text-lg mb-1"></i>
            <span class="text-xs">è¨˜å¸³</span>
        </button>
        <button class="tab-button flex flex-col items-center text-gray-500 flex-1" onclick="showTab('lists')">
            <i class="fas fa-list-ul text-lg mb-1"></i>
            <span class="text-xs">æ¸…å–®</span>
        </button>
        <button class="tab-button flex flex-col items-center text-gray-500 flex-1" onclick="showTab('info')">
            <i class="fas fa-info-circle text-lg mb-1"></i>
            <span class="text-xs">è³‡è¨Š</span>
        </button>
    </nav>

    <script>
        // =======================================================
        // Global Data (è¡Œç¨‹è³‡è¨Š)
        // =======================================================
        const itineraryData = [
            {
                day: 1,
                date: 'Day 1',
                title: 'æŠµé”æ–°æ½Ÿèˆ‡ä¿¡æ¿ƒå·å¤œæ™¯',
                weather: { temp: '18Â°C', desc: 'å‚æ™šå°é›¨' }, // æ¨¡æ“¬å¤©æ°£
                events: [
                    { time: '18:00', type: 'transport', title: 'æŠµé”KIJæ–°æ½Ÿæ©Ÿå ´', details: 'IT228èˆªç­ï¼Œå°åŒ—13:45èµ·é£›ï¼Œé è¨ˆ18:00æŠµé”æ–°æ½Ÿã€‚', icon: 'fa-plane', important: true },
                    { time: '18:00 - 19:00', type: 'transport', title: 'æ©Ÿå ´å·´å£«è‡³æ–°æ½Ÿç«™', details: 'å¾æ©Ÿå ´æ­ä¹˜å·´å£«å‰å¾€æ–°æ½Ÿç«™ï¼Œé€™æ˜¯å…¨ç¨‹å”¯ä¸€éœ€è¦æ­ä¹˜å·´å£«çš„å€æ®µã€‚', icon: 'fa-bus' },
                    { time: '19:00', type: 'hotel', title: 'è¾¦ç†å…¥ä½æ‰‹çºŒ', details: 'æŠµé”æ–°æ½Ÿç«™å¾Œï¼Œè‡³æ–°æ½Ÿæ±æ€¥REIé£¯åº—è¾¦ç†å…¥ä½ã€‚', icon: 'fa-hotel' },
                    { time: '19:30 - 21:30', type: 'food', title: 'æ–°æ½Ÿç«™å‘¨é‚Šæ™šé¤', details: 'æ¨è–¦äº«ç”¨ç•¶åœ°ç¾é£Ÿã€‚', highlight: ['å¿…åƒ: ã¸ããã°', 'å¿…åƒ: æ–°é®®å£½å¸/æµ·é®®ä¸¼'], links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/0'}]},
                    { time: 'é¤å¾Œ', type: 'spot', title: 'è¬ä»£æ©‹å¤œæ™¯æ•£ç­–', details: 'æ­¥è¡Œè‡³è¬ä»£æ©‹æ¬£è³ä¿¡æ¿ƒå·çš„è¿·äººå¤œæ™¯ã€‚', icon: 'fa-bridge', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/1'}]}
                ]
            },
            {
                day: 2,
                date: 'Day 2',
                title: 'æ·±åº¦æ­¥è¡Œï¼šæ¸…é…’ã€æ–‡å‰µèˆ‡åŸå¸‚ç¶ æ„',
                weather: { temp: '22Â°C', desc: 'æ™´æ™‚å¤šé›²' },
                events: [
                    { time: '09:30 - 10:30', type: 'spot', title: 'Ponshukan é©›åº— (æ¸…é…’è©¦é£²)', details: 'æ–°æ½Ÿç«™å…§æ¸…é…’åšç‰©é¤¨ï¼Œå¿…åšæ˜¯æŠ•å¹£è©¦é£²æ¸…é…’ã€‚', highlight: ['å¿…åš: æŠ•å¹£è©¦é£²æ¸…é…’', 'å¿…è²·: æ–°æ½ŸéŠ˜é…’'], icon: 'fa-wine-glass', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/2'}]},
                    { time: '10:30 - 13:40', type: 'spot', title: 'æ²¼å‚éœ²è‡ºå•†åº—è¡— (åˆé¤/æ–‡å‰µ)', details: 'æ­¥è¡Œç´„25-30åˆ†é˜ (2.0 km)ï¼Œäº«å—åˆé¤èˆ‡æ–‡å‰µæ•£ç­–ã€‚', highlight: ['å¿…åƒ: ç•¶åœ°ç‰¹è‰²åˆé¤', 'å¿…è²·: æ–‡å‰µé›œè²¨'], icon: 'fa-store', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/3'}]},
                    { time: '13:40 - 15:10', type: 'spot', title: 'ç™½å±±ç¥ç¤¾èˆ‡ç™½å±±å…¬åœ’', details: 'æ­¥è¡Œç´„35-40åˆ†é˜ (2.5 km)ï¼Œæ„Ÿå—æ—¥ç³»åˆç§‹çš„èŠåš´èˆ‡åŸå¸‚ç¶ æ„ã€‚', icon: 'fa-shrine', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/4'}]},
                    { time: '16:00 - 17:30', type: 'spot', title: 'æ–°æ½Ÿæ—¥å ±å‚³åª’å¤§å»ˆ (Media Ship)', details: 'æ­¥è¡Œç´„15-20åˆ†é˜ (1.2 km)ï¼Œå…è²»è§€æ™¯å°æ˜¯è§€è³æ—¥è½å’Œä¿¡æ¿ƒå·ç¾æ™¯çš„çµ•ä½³åœ°é»ã€‚', highlight: ['å¿…çœ‹: ä¿¡æ¿ƒå·æ—¥è½', 'å¿…çœ‹: ä½æ¸¡å³¶å‰ªå½±'], icon: 'fa-building', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/5'}]},
                    { time: '17:30 - 21:00', type: 'food', title: 'è¬ä»£City è³¼ç‰©èˆ‡æ™šé¤', details: 'æ­¥è¡Œå¯é”çš„è³¼ç‰©ä¸­å¿ƒå€åŸŸã€‚', icon: 'fa-shopping-bag' }
                ]
            },
            {
                day: 3,
                date: 'Day 3',
                title: 'éµé“ä¹‹æ—…ï¼šå½Œå½¥èˆ‡è­·åœ‹ç¥ç¤¾',
                weather: { temp: '20Â°C', desc: 'é™°å¤©' },
                events: [
                    { time: '07:30', type: 'transport', title: 'JRè¶Šå¾Œç·šè‡³å‰ç”°ç«™è½‰ä¹˜', details: 'å¾æ–°æ½Ÿç«™æ­ä¹˜JRè¶Šå¾Œç·šã€‚', important: true, icon: 'fa-train' },
                    { time: 'ç´„08:20', type: 'transport', title: 'å‰ç”°ç«™è½‰ä¹˜JRå½Œå½¥ç·š', details: 'é—œéµè½‰ä¹˜é»ï¼æ³¨æ„æœˆå°æ¨™ç¤ºæ›ä¹˜ã€ŒJRå½Œå½¥ç·šã€ï¼Œå–®ç¨‹ç¸½è»Šç¨‹ç´„70åˆ†é˜ã€‚', important: true, icon: 'fa-exchange-alt' },
                    { time: '08:40 - 12:00', type: 'spot', title: 'å½Œå½¥ç¥ç¤¾å€åŸŸæ•£ç­–', details: 'åƒè§€è¶Šå¾Œåœ‹ä¸€ä¹‹å®®ï¼Œé€›è€è¡—ä¸¦å¯æ­çºœè»Šä¸Šå±±ã€‚', highlight: ['å¿…åš: æ­çºœè»Šä¸Šå½Œå½¥å±±', 'å¿…åƒ: å½Œå½¥æº«æ³‰é¥…é ­/ç†Šè²“ç‡’'], icon: 'fa-shrine', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/6'}]},
                    { time: 'ç´„ 12:00', type: 'transport', title: 'è¿”å›æ–°æ½Ÿç«™ (åˆé¤)', details: 'æ­ä¹˜JRå¾ªåŸè·¯è¿”å›æ–°æ½Ÿï¼Œä¸¦äº«ç”¨åˆé¤ã€‚', icon: 'fa-train' },
                    { time: '13:30 - 14:00', type: 'transport', title: 'JRè¶Šå¾Œç·šè‡³ç™½å±±ç«™', details: 'å¾æ–°æ½Ÿç«™æ­ä¹˜JRè¶Šå¾Œç·šçŸ­é€”ç§»å‹•ï¼ˆç´„5åˆ†é˜ï¼‰è‡³ç™½å±±ç«™ã€‚', icon: 'fa-train' },
                    { time: '14:30 - 17:00', type: 'spot', title: 'æ–°æ½Ÿç¸£è­·åœ‹ç¥ç¤¾', details: 'å¾ç™½å±±ç«™æ­¥è¡Œç´„25åˆ†é˜ (1.8 km) å‰å¾€ã€‚', icon: 'fa-shrine', links: [{text: 'Google Maps', url: 'https://maps.app.goo.gl/7'}]},
                    { time: '18:30', type: 'food', title: 'æ–°æ½Ÿç«™å‘¨é‚Šæ™šé¤', details: 'åœ¨æ–°æ½Ÿç«™å‘¨é‚Šäº«ç”¨æ™šé¤ã€‚', icon: 'fa-utensils' }
                ]
            },
            {
                day: 4,
                date: 'Day 4',
                title: 'è³¼ç‰©è¡åˆºèˆ‡è¿”ç¨‹',
                weather: { temp: '21Â°C', desc: 'å¤šé›²æ™‚æ™´' },
                events: [
                    { time: '09:30 - 12:00', type: 'shopping', title: 'CoCoLo Niigata è³¼ç‰©è¡åˆº', details: 'åœ°é»é–å®šåœ¨æ–°æ½Ÿç«™å…§çš„è³¼ç‰©å•†å ´ã€‚', highlight: ['å¿…è²·: æ¸…é…’', 'å¿…è²·: æ–°æ½Ÿç±³', 'å¿…è²·: ç±³è“ä»™è²', 'å¿…è²·: ç¬¹ç³°å­'], icon: 'fa-shopping-basket' },
                    { time: '12:00 - 14:00', type: 'food', title: 'æœ€å¾Œåˆé¤', details: 'äº«å—é›¢é–‹å‰çš„ç¾é£Ÿã€‚', highlight: ['æ¨è–¦: å·´å£«ä¸­å¿ƒå’–å“©', 'æ¨è–¦: æµ·é®®ä¸¼'], icon: 'fa-utensils' },
                    { time: '15:30 - 16:00', type: 'transport', title: 'å‰å¾€æ–°æ½Ÿæ©Ÿå ´', details: 'æ­ä¹˜æ©Ÿå ´å·´å£«æˆ–è¨ˆç¨‹è»Šå‰å¾€æ–°æ½Ÿæ©Ÿå ´ã€‚', important: true, icon: 'fa-bus' },
                    { time: '18:50', type: 'transport', title: 'æ­ä¹˜ç­æ©Ÿè¿”ç¨‹', details: 'IT229èˆªç­ï¼Œé è¨ˆ21:25æŠµé”å°åŒ—ã€‚', icon: 'fa-plane', important: true }
                ]
            }
        ];

        const guideData = [
            {
                title: 'æ¸…é…’ä¹‹é­‚ï¼šPonshukan é©›åº—',
                subtitle: 'æ–°æ½Ÿç±³çš„ç²¾è¯é«”é©—',
                icon: 'fa-wine-glass',
                content: `
                    <p class="mb-3">æ–°æ½Ÿæ˜¯æ—¥æœ¬é¦–å±ˆä¸€æŒ‡çš„ã€Œæ¸…é…’ç‹åœ‹ã€ï¼Œæ“æœ‰è¶…é90å®¶é…’è—ï¼Œå¾—ç›Šæ–¼å„ªè³ªçš„è¶Šå…‰ç±³å’Œç´”æ·¨çš„èé›ªæ°´ã€‚Ponshukanï¼ˆã½ã‚“ã—ã‚…é¤¨ï¼‰ä½æ–¼æ–°æ½Ÿç«™å…§ï¼Œæ˜¯æ¸…é…’æ„›å¥½è€…çš„å¤©å ‚ã€‚</p>
                    <p class="text-sm font-bold text-accent-green mb-2">ã€å¿…åšé«”é©—ã€‘</p>
                    <p class="mb-3">åªéœ€æ”¯ä»˜500æ—¥åœ“ï¼Œå³å¯ç²å¾—5æšä»£å¹£å’Œå°é…’æ¯ï¼Œå¯ä»¥å¾è¿‘100ç¨®æ¸…é…’ä¸­é¸æ“‡è©¦é£²ã€‚è«‹å‹™å¿…è©¦è©¦ç•¶åœ°çŸ¥åçš„ã€Œè¶Šä¹ƒå¯’æ¢…ã€ã€ã€Œä¹…ä¿ç”°ã€æˆ–ã€Œå…«æµ·å±±ã€ã€‚</p>
                    <p class="text-sm font-bold text-accent-green mb-2">ã€éš±è—ç¾é£Ÿã€‘</p>
                    <p class="mb-3">é¤¨å…§é‚„æœ‰è²©å”®åç‚ºã€Œçˆ†å½ˆé£¯ç³°ã€çš„å·¨ç„¡éœ¸é£¯ç³°ï¼Œä½¿ç”¨æ–°æ½Ÿç±³è£½ä½œï¼Œæ˜¯è§£é…’åˆé£½è¶³çš„åœ¨åœ°ç‰¹è‰²ç¾é£Ÿã€‚</p>
                `,
                map: null
            },
            {
                title: 'ä¿¡ä»°èˆ‡æ­·å²ï¼šå½Œå½¥ç¥ç¤¾',
                subtitle: 'è¶Šå¾Œåœ‹ä¸€ä¹‹å®®',
                icon: 'fa-shrine',
                content: `
                    <p class="mb-3">å½Œå½¥ç¥ç¤¾ï¼ˆå½Œå½¥å¤§ç¤¾ï¼‰æ˜¯æ–°æ½Ÿç¸£å…§æœ€è‘—åçš„ç¥ç¤¾ï¼Œä¹Ÿæ˜¯ã€Œè¶Šå¾Œåœ‹ä¸€ä¹‹å®®ã€ï¼Œåœ°ä½å´‡é«˜ã€‚æ“šèªªå·²æœ‰å…©åƒå¹´æ­·å²ï¼Œä¸»è¦ç¥­ç¥€çš„æ˜¯å¤©é¦™å±±å‘½ï¼Œè¢«å°Šç‚ºé–‹ç™¼è¶Šå¾Œå¹³åŸçš„ç¥–ç¥ã€‚</p>
                    <p class="text-sm font-bold text-accent-green mb-2">ã€é‡é»æ”»ç•¥ã€‘</p>
                    <ul class="list-disc list-inside ml-2 text-sm space-y-1">
                        <li><strong>äºŒä¹‹é³¥å±…ï¼š</strong>è¢«è¦–ç‚ºèƒ½é‡ç‰¹åˆ¥å¼·å¤§çš„å…¥å£ã€‚</li>
                        <li><strong>ç‰ä¹‹æ©‹ï¼š</strong>åªæœ‰ç¥æ˜æ‰èƒ½é€šè¡Œçš„æ©‹ï¼ŒéŠå®¢åªèƒ½åœ¨æ—å´è§€è³ã€‚</li>
                        <li><strong>å½Œå½¥å±±çºœè»Šï¼š</strong>å¾ç¥ç¤¾è€è¡—å¯æ­ä¹˜æ¥é§è»Šæˆ–ç›´æ¥å‰å¾€çºœè»Šç«™ï¼Œç™»é ‚å¾Œå¯ä¿¯ç°è¶Šå¾Œå¹³åŸã€æ—¥æœ¬æµ·åŠä½æ¸¡å³¶ã€‚</li>
                    </ul>
                `,
                map: `<iframe width="100%" height="250" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://www.openstreetmap.org/export/embed.html?bbox=138.8340%2C37.8250%2C138.8600%2C37.8420&amp;layer=mapnik&amp;marker=37.8340%2C138.8470" style="border: 1px solid black;"></iframe>`
            },
            {
                title: 'Bç´šç¾é£Ÿå‚³èªªï¼šå·´å£«ä¸­å¿ƒå’–å“©',
                subtitle: 'è¬ä»£Cityçš„æ‡·èˆŠæ»‹å‘³',
                icon: 'fa-utensils',
                content: `
                    <p class="mb-3">ä½æ–¼è¬ä»£Cityå·´å£«ç¸½ç«™äºŒæ¨“çš„ã€Œåç‰© å·´å£«ä¸­å¿ƒå’–å“©ã€ï¼ˆãƒã‚¹ã‚»ãƒ³ã‚¿ãƒ¼ã®ã‚«ãƒ¬ãƒ¼ï¼‰ï¼Œæ˜¯æ–°æ½Ÿå¸‚æ°‘å¿ƒä¸­æœ€å…·ä»£è¡¨æ€§çš„Bç´šç¾é£Ÿï¼Œä¹Ÿæ˜¯æ—…äººé›¢é–‹å‰çš„å¿…åƒé …ç›®ä¹‹ä¸€ã€‚</p>
                    <p class="text-sm font-bold text-accent-green mb-2">ã€ç‰¹è‰²ã€‘</p>
                    <p class="mb-3">å’–å“©é¡è‰²å‘ˆç¾æ‡·èˆŠçš„**é»ƒè‰²**ï¼Œå£æ„Ÿæ¿ƒç¨ ï¼Œå£å‘³å¸¶è‘—è”¬èœçš„ç”œå‘³èˆ‡å¾®è¾£æ„Ÿã€‚è¨±å¤šäººæ’éšŠå°±æ˜¯ç‚ºäº†é€™ä¸€å£å‚³æ‰¿æ•¸åå¹´çš„å¤æ—©å‘³ã€‚æ’éšŠäººæ½®å¤šï¼Œå»ºè­°é¿é–‹åˆé¤å°–å³°æ™‚æ®µã€‚</p>
                    <p class="text-sm font-bold text-accent-green mb-2">ã€ä½ç½®ã€‘</p>
                    <p class="mb-3">ä½æ–¼è¬ä»£Cityçš„å·´å£«ç¸½ç«™äºŒæ¨“è§’è½ï¼Œå®¹æ˜“è¢«è§€å…‰å®¢å¿½ç•¥ï¼Œä½†è·Ÿè‘—æ’éšŠäººé¾èµ°å°±å°äº†ï¼</p>
                `,
                map: null
            }
        ];

        const initialChecklist = [
            'è­·ç…§/ç°½è­‰',
            'ç¶²å¡/eSIM',
            'æ—¥å¹£ç¾é‡‘',
            'åœ‹éš›ä¿¡ç”¨å¡',
            'å……é›»ç·š/è¡Œå‹•é›»æº',
            'å€‹äººè—¥å“/å¸¸å‚™è—¥',
            'é›¨å…· (é›¨å‚˜/é›¨è¡£)',
            'è¼•ä¾¿å¤–å¥—/é˜²é¢¨è¡£',
            'é£¯åº—é ç´„å–®é›»å­æª”'
        ];

        // =======================================================
        // LocalStorage & Initial Load
        // =======================================================
        
        let currentExpensePhotoBase64 = null;
        const DEFAULT_EXCHANGE_RATE = 4.8; 

        function initApp() {
            loadExpenses();
            loadChecklist();
            loadNotes();
            renderItinerary();
            renderGuides();
            document.getElementById('exchangeRateInput').value = localStorage.getItem('exchangeRate') || DEFAULT_EXCHANGE_RATE;
        }

        // =======================================================
        // UI Navigation
        // =======================================================
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');

            // ç¢ºä¿è¨˜å¸³é é¢é‡æ–°æ¸²æŸ“ç¸½é¡
            if (tabId === 'wallet') {
                calculateTotalExpenses();
            }
            // ç¢ºä¿å‚™å¿˜éŒ„æ›´æ–°é¡¯ç¤º
            if (tabId === 'lists') {
                loadNotes();
            }
        }

        // =======================================================
        // PLAN (è¡Œç¨‹è¡¨) Logic
        // =======================================================

        function renderItinerary() {
            const container = document.getElementById('itinerary-container');
            container.innerHTML = itineraryData.map((dayData, dayIndex) => `
                <div class="mb-8">
                    <div class="flex items-center mb-4">
                        <span class="text-lg font-bold text-accent-green mr-3">${dayData.date}</span>
                        <h3 class="text-xl font-bold">${dayData.title}</h3>
                        <span class="ml-auto text-sm text-gray-500"><i class="fas fa-cloud mr-1"></i>${dayData.weather.temp}</span>
                    </div>
                    <div class="relative pl-4">
                        ${dayData.events.map((event, eventIndex) => `
                            <div class="timeline-item ${event.important ? 'timeline-important' : ''} ${eventIndex === dayData.events.length - 1 ? 'timeline-end' : ''}">
                                <div class="timeline-dot"></div>
                                <div class="timeline-line"></div>
                                <div class="card p-4 ml-4">
                                    <div class="flex items-center mb-1">
                                        <i class="fas ${event.icon} mr-2 text-accent-green"></i>
                                        <span class="text-sm font-jp font-bold ${event.important ? 'highlight-orange' : 'text-accent-brown'}">${event.time}</span>
                                    </div>
                                    <h4 class="text-lg font-bold mb-2">${event.title}</h4>
                                    <p class="text-sm text-gray-700">${event.details}</p>
                                    ${event.highlight ? `<div class="mt-2 flex flex-wrap gap-2">${event.highlight.map(h => `<span class="${h.includes('åƒ') ? 'badge-food' : (h.includes('è²·') ? 'badge-buy' : 'badge-tip')}">${h}</span>`).join('')}</div>` : ''}
                                    ${event.links ? `<div class="mt-3 flex gap-2">${event.links.map(link => `<a href="${link.url}" target="_blank" class="link-button"><i class="fas fa-map-marker-alt mr-2"></i>${link.text}</a>`).join('')}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        // =======================================================
        // GUIDE (æ·±åº¦å°è¦½) Logic
        // =======================================================
        function renderGuides() {
            const container = document.getElementById('guide-content');
            container.innerHTML = guideData.map(guide => `
                <div class="card p-5 mb-6">
                    <h3 class="text-xl font-bold mb-1 text-accent-green"><i class="fas ${guide.icon} mr-2"></i>${guide.title}</h3>
                    <p class="text-sm text-accent-brown font-medium mb-4">${guide.subtitle}</p>
                    <div class="text-base leading-relaxed">${guide.content}</div>
                    ${guide.map ? `<div class="mt-4 border border-border rounded-lg overflow-hidden">${guide.map}</div>` : ''}
                </div>
            `).join('');
        }

        // =======================================================
        // WALLET (è¨˜å¸³èˆ‡åŒ¯ç‡) Logic
        // =======================================================
        
        let currentPhotoBase64 = null; // Used for temporary storage during expense entry

        function appendCalc(value) {
            const input = document.getElementById('calcInput');
            if (value === 'x') value = '*'; // Convert display to actual operator
            input.value += value;
        }

        function clearCalc() {
            document.getElementById('calcInput').value = '';
            document.getElementById('totalJPY').textContent = '0';
            document.getElementById('totalTWD').textContent = '0';
        }

        function calculateExchange() {
            const expression = document.getElementById('calcInput').value.replace(/x/g, '*');
            const rate = parseFloat(document.getElementById('exchangeRateInput').value) || DEFAULT_EXCHANGE_RATE;
            localStorage.setItem('exchangeRate', rate);

            try {
                // Safely evaluate the expression
                const jpyTotal = eval(expression) || 0;
                const twdTotal = (jpyTotal / rate).toFixed(0); // Round to nearest TWD

                document.getElementById('totalJPY').textContent = jpyTotal.toLocaleString('en');
                document.getElementById('totalTWD').textContent = twdTotal.toLocaleString('en');
            } catch (e) {
                alert('ç„¡æ•ˆçš„ç®—å¼ï¼');
                document.getElementById('totalJPY').textContent = 'Error';
                document.getElementById('totalTWD').textContent = 'Error';
            }
        }

        function getExpenses() {
            const expenses = localStorage.getItem('expenses');
            return expenses ? JSON.parse(expenses) : [];
        }

        function saveExpenses(expenses) {
            localStorage.setItem('expenses', JSON.stringify(expenses));
        }

        function calculateTotalExpenses() {
            const expenses = getExpenses();
            const rate = parseFloat(localStorage.getItem('exchangeRate')) || DEFAULT_EXCHANGE_RATE;
            
            const totalJPY = expenses.reduce((sum, item) => sum + item.jpy, 0);
            const totalTWD = (totalJPY / rate).toFixed(0);

            document.getElementById('totalExpensesJPY').textContent = totalJPY.toLocaleString('en');
            document.getElementById('totalExpensesTWD').textContent = totalTWD.toLocaleString('en');
        }

        function loadExpenses() {
            const expenses = getExpenses();
            const list = document.getElementById('expenseList');
            const rate = parseFloat(localStorage.getItem('exchangeRate')) || DEFAULT_EXCHANGE_RATE;
            
            list.innerHTML = expenses.map((item, index) => {
                const twdAmount = (item.jpy / rate).toFixed(0);
                return `
                    <li class="p-3 bg-gray-50 rounded-lg flex items-center justify-between border border-border">
                        <div class="flex items-center flex-1 mr-3">
                            ${item.photo ? `<img src="${item.photo}" class="w-12 h-12 object-cover mr-3 rounded-md" alt="æ”¶æ“šç¸®åœ–">` : ''}
                            <div class="flex-1 min-w-0">
                                <p class="font-bold text-base whitespace-nowrap overflow-hidden text-ellipsis">${item.item}</p>
                                <p class="text-xs text-accent-green font-jp">${item.jpy.toLocaleString('en')} JPY</p>
                                <p class="text-xs text-accent-brown font-jp">ç´„ ${twdAmount.toLocaleString('en')} TWD</p>
                            </div>
                        </div>
                        <button onclick="deleteExpense(${index})" class="text-red-500 text-sm ml-2 p-1"><i class="fas fa-trash-alt"></i></button>
                    </li>
                `;
            }).join('');

            calculateTotalExpenses();
        }

        function deleteExpense(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ')) return;
            const expenses = getExpenses();
            expenses.splice(index, 1);
            saveExpenses(expenses);
            loadExpenses();
        }

        function previewExpensePhoto(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Max width for image compression
                    
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH) {
                        height = height * (MAX_WIDTH / width);
                        width = MAX_WIDTH;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to JPEG and store base64
                    currentPhotoBase64 = canvas.toDataURL('image/jpeg', 0.8); // 80% quality
                    
                    document.getElementById('expensePhotoPreview').src = currentPhotoBase64;
                    document.getElementById('photoPreviewContainer').classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeExpensePhoto() {
            currentPhotoBase64 = null;
            document.getElementById('expensePhoto').value = '';
            document.getElementById('photoPreviewContainer').classList.add('hidden');
            document.getElementById('expensePhotoPreview').src = '';
        }

        function addExpense() {
            const item = document.getElementById('expenseItem').value.trim();
            const jpy = parseInt(document.getElementById('expenseJPY').value) || 0;

            if (!item || jpy <= 0) {
                alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„å“é …å’Œæ—¥å¹£é‡‘é¡ã€‚');
                return;
            }

            const expenses = getExpenses();
            expenses.unshift({
                item: item,
                jpy: jpy,
                photo: currentPhotoBase64,
                timestamp: Date.now()
            });
            saveExpenses(expenses);

            // Reset form
            document.getElementById('expenseItem').value = '';
            document.getElementById('expenseJPY').value = '';
            removeExpensePhoto(); // Also resets currentPhotoBase64

            loadExpenses();
        }


        // =======================================================
        // LISTS (æ¸…å–®) Logic
        // =======================================================
        
        function getChecklist() {
            const checklist = localStorage.getItem('checklist');
            return checklist ? JSON.parse(checklist) : initialChecklist.map(item => ({ text: item, completed: false }));
        }

        function saveChecklist(checklist) {
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }

        function loadChecklist() {
            let checklist = getChecklist();
            if (checklist.length === 0) {
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡è¼‰å…¥ï¼Œä½¿ç”¨åˆå§‹æ¸…å–®
                checklist = initialChecklist.map(item => ({ text: item, completed: false }));
                saveChecklist(checklist);
            }
            
            const list = document.getElementById('checklist');
            list.innerHTML = checklist.map((item, index) => `
                <li class="flex items-center bg-gray-50 p-2 rounded-md border border-border transition duration-150 ease-in-out hover:bg-gray-100">
                    <input type="checkbox" id="check-${index}" class="form-checkbox h-5 w-5 text-accent-green rounded border-gray-300 focus:ring-accent-green" ${item.completed ? 'checked' : ''} onclick="toggleChecklistItem(${index})">
                    <label for="check-${index}" class="ml-3 text-base flex-1 ${item.completed ? 'line-through text-gray-500' : 'text-primary-text'}">${item.text}</label>
                    <button onclick="deleteChecklistItem(${index})" class="text-red-400 hover:text-red-600 ml-2"><i class="fas fa-trash-alt text-sm"></i></button>
                </li>
            `).join('');
        }

        function toggleChecklistItem(index) {
            const checklist = getChecklist();
            checklist[index].completed = !checklist[index].completed;
            saveChecklist(checklist);
            loadChecklist(); // Rerender to apply line-through style
        }

        function deleteChecklistItem(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ¸…å–®é …ç›®å—ï¼Ÿ')) return;
            const checklist = getChecklist();
            checklist.splice(index, 1);
            saveChecklist(checklist);
            loadChecklist();
        }

        function addChecklistItem() {
            const input = document.getElementById('newChecklistItem');
            const text = input.value.trim();
            if (text) {
                const checklist = getChecklist();
                checklist.push({ text: text, completed: false });
                saveChecklist(checklist);
                input.value = '';
                loadChecklist();
            }
        }

        function saveNotes() {
            const notesText = document.getElementById('personalNotes').value;
            localStorage.setItem('personalNotes', notesText);
            alert('å‚™å¿˜éŒ„å·²å„²å­˜ï¼');
            loadNotes();
        }

        function loadNotes() {
            const notesText = localStorage.getItem('personalNotes') || '';
            document.getElementById('personalNotes').value = notesText;
            
            const outputDiv = document.getElementById('notesOutput');
            
            // è™•ç†æ›è¡Œ
            let htmlContent = notesText.split('\n').map(line => {
                // åµæ¸¬ç¶²å€ä¸¦è½‰æ›ç‚ºæŒ‰éˆ•
                const urlRegex = /(https?:\/\/[^\s]+)/g;
                if (urlRegex.test(line)) {
                    // æ‰¾åˆ°æ‰€æœ‰é€£çµ
                    const links = line.match(urlRegex);
                    // å°‡é€£çµæ›¿æ›ç‚ºæŒ‰éˆ•
                    let lineHtml = line;
                    links.forEach(url => {
                        const buttonHtml = `<a href="${url}" target="_blank" class="link-button bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-md text-sm"><i class="fas fa-link mr-1"></i>${url.length > 30 ? url.substring(0, 30) + '...' : url}</a>`;
                        lineHtml = lineHtml.replace(url, buttonHtml);
                    });
                    return `<p class="mb-2">${lineHtml}</p>`;
                }
                return `<p class="mb-2 text-gray-700">${line || '&nbsp;'}</p>`;
            }).join('');

            outputDiv.innerHTML = htmlContent;
        }

        // =======================================================
        // Initialize Application
        // =======================================================
        window.onload = initApp;
    </script>
</body>
</html>